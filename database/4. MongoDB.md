# MongoDB
### 참고자료
* [MongoDB의 데이터 복제 방식](https://m.blog.naver.com/sehyunfa/221653690145)
* [MongoDB 이해하기](https://kciter.so/posts/about-mongodb)
* [MongoDB란 - 역사, 설계 목표, 핵심 기능, 몽고DB를 사용하는 이유](https://hoing.io/archives/1379)
* [MongoDB index 개념과 indexing 전략](https://ryu-e.tistory.com/1)
* [인덱스](https://www.zerocho.com/category/MongoDB/post/57a6faddc90c5815005babc3)
### MongoDB
- NoSQL로 분류되는 도큐먼트 지향 데이터베이스 시스템
- 수평 확장 등의 강점을 가지며 데이터의 교환시 Binary JSON 문서 형태로 저장하여 여러 서버에 분산 저장 및 확장이 용이
    - Binary JSON: JSON을 바이너리형태로 인코딩한 바이트 문자열
- 인 메모리 디비
- Schemaless. 따라서 같은 콜렉션에 있어도 다른 데이터 타입과 필드를 가질 수 있음
- 내장 도큐먼트와 배열을 허용하므로써 도큐먼트 지향 모델은 복잡한 계층 관계를 하나의 레코드로 나타낼 수 있음
- 몽고디비는 ACID가 아닌 BASE 구조를 따르고 있음
### 장점
- 몽고디비의 가장 큰 장점은 고가용성과 대용량 분산처리
- 이를 구현하기 위해서의 핵심 기술은 ```샤딩```과 ```레플리케이션```
    ### 샤딩
    - 데이터의 속성에 따라 분산 데이터베이스에 저장하는 방식
    - 현 시점에서 구성할 수 있는 노드 수는 100
    - shard key
        - 샤드에 저장 될 데이터를 나누는 기준
        - 샤드키를 잘못 잡으면 한 샤드에 데이터가 몰림. 비효율적
        - 샤드키를 설정하는 기준?
            - 카디널러티
                - 사용성을 고려해야함.
                - 필드에 담긴 종류를 고려해야함
                - ex) age는 낮은 카디널러티
            - 빈도수
                - 한 곳에 몰릴 수 있는 가능성이 높음
            - 선형적으로 증가하는 형태의 데이터
                - max값 설정이 애매함
    - sharding 전략
        - range sharding
        - hash sharding
        - zone sharding
    - chunk
        - 공유 데이터의 최하위 단계
        - 샤드에 분산된 데이터를 청크 단위로 관리
    ### 레플리케이션
    - 여러 개의 데이터베이스에 데이터를 동기화하는 과정
    - 여러 개의 동일한 데이터베이스를 운영하기 위해 필요한 작업
    - 복제의 가장 큰 이유는 장애 발생시 지속적인 서비스 운영을 통해 고가용성의 목적
    - 수평적 확장과 수직적 확장
        - 수직적 확장(scale up): 데이터 베이스의 스펙 자체를 올리는 것입니다. 기존 보다 빠른 처리가 가능하지만 물리적인 한계가 있다는 점이 있습니다
        - 수평적 확장(scale out): 여러 개의 데이터베이스를 복사하여 특정 데이터베이스가 죽더라도 정상적인 서비를 제공할 수 있습니다. 이를 통해 데이터 복구를 위한 백업 또한 수월하게 진행할 수 있습니다
### Index
- 몽고디비 인덱스를 사용하면 효율적으로 쿼리 할 수 있음
- 인덱스를 사용하지 않는 쿼리를 ```컬렉션 스캔```이라고 함
- 인덱스 종류
    - 기본 인덱스 _id
        - 몽고디비 컬렉션은 기본적으로 _id 필드에 인덱스가 존재
        - 따로 인덱스를 설정하지 않으면 Object_id를 _id  필드값으로 설정
        - _id 인덱스는 유니크하고 같은 _id를 가진 문서를 중복적으로 추가하는 것을 방지
    - 단일 필드 인덱스
        - 몽고디비 드라이버가 지정하는 _id 인덱스 이외에도 사용자가 지정할 수 있는 단일 필드 인덱스가 있음
    - 복합 필드 인덱스
        - 2개 이상의 필드로 구성된 인덱스
    - 멀티키 인덱스
        - 필드 타입이 배열일 경우 인덱스를 적용할 떄 mutil key 인덱스를 사용
    - 공간 키 인덱스
    - 해시 인덱스
- 인덱스 선정 기준 ?
    - 인덱스 카디널러티
    - 컬렉션의 한 필드에 대해 고유값이 얼마나 많은지 나타냄
    - ex) gender, input/output 같은 것은 낮은 카디널러티를 가짐. 반면 username, email과 같은 것은 높은 카디널리티를 가짐
- 몽고디비 인덱스분석 explain()
    1. 몽고디비 쿼리가 들어오면 쿼리 모양을 확인
    2. 해당 쿼리에 대한 인덱스 선별(ex. 인덱스 5개면 어느 것이 필요한 인덱스인지 결정)
    3. 이 선별된 인덱스를 기준으로 쿼리 플랜을 만들고 병렬적으로 이 쿼리를 실행해봄
    4. 이후 동일한 후속 쿼리가 있을 때 기존 정보를 통해 어떤 인덱스를 선택할지 알 수 있음
    5. 서버는 캐시에 쿼리 플랜을 저장
    6. 시간이 지나면 쿼리 플랜이 캐시에서 제거
### read / write
- read
    - mongdb에서 read 작업은 모든 분산 노드에서 작용
- write
    - mongdb에서 write 작업은 primary 노드에서 동작
    - 만약 이 프라이머리 노드에 장애가 발생한다면 죽은 것을 빠르게 확인 후 secondary db가 새로운 primary db로 선출
### mongos
- 다수 구성된 샤드의 인터페이스
### config server
- 전체 클러스터의 메타 데이터
- 구성 설정 등을 저장하는 서버
